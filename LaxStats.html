<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>LaxTracker Web (Adjusted)</title>
    <style>
        :root {
            --bg-color: #f2f2f7;
            --card-bg: #ffffff;
            --our-team-color: #34c759; /* Green */
            --opponent-color: #ff3b30; /* Red */
            --blue: #007aff;
            --orange: #ff9500;
            --purple: #af52de;
            --yellow: #ffcc00;
            --teal: #30b0c7;
            --card-color: #ffcc00; /* Yellow for cards */
            --save-color: #00aaff; /* Light blue for saves */
            --to-color: #ff6347; /* Tomato red for turnovers */
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden; 
            
            padding-top: constant(safe-area-inset-top);
            padding-top: env(safe-area-inset-top);
        }

        /* --- TOP WINDOW: SCOREBOARD (UNCHANGED) --- */
        #scoreboard {
            background-color: var(--card-bg);
            padding: 2px 5px; 
            border-bottom: 1px solid #ccc;
            flex-shrink: 0;
        }

        .score-row {
            display: grid; 
            grid-template-columns: 1fr 1fr 1fr; 
            gap: 2px; 
            margin-bottom: 2px; 
        }

        .score-item { 
            text-align: center; 
            padding: 2px 0; 
            border-right: 1px solid #eee; 
        }
        .score-item:last-child { border-right: none; }

        .score-val { 
            font-size: 15px; 
            font-weight: bold; 
            display: block; 
            line-height: 1.1;
            white-space: nowrap;
        }
        .score-label { 
            font-size: 7px; 
            color: #666; 
            font-weight: bold; 
            text-transform: uppercase; 
            line-height: 1.0;
        }
        .team-our { color: var(--our-team-color); }
        .team-opp { color: var(--opponent-color); }
        .score-sep { color: #666; font-weight: normal; margin: 0 1px; }


        /* --- MIDDLE WINDOW: MAIN CONTENT (COMPACT) - Now maximized --- */
        #main-content {
            flex-grow: 1; /* Takes up all remaining space */
            overflow-y: auto;
            padding: 5px 8px; 
            padding-bottom: 60px; 
        }

        /* BUTTON GRID (COMPACT) */
        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 6px; 
            margin-bottom: 6px; 
        }
        .grid-extended {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr; 
            gap: 6px; 
            margin-bottom: 6px; 
        }

        button.stat-btn {
            border: none;
            color: white;
            padding: 10px; 
            font-size: 14px; 
            font-weight: 800;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            cursor: pointer;
            text-transform: uppercase;
            touch-action: manipulation;
        }
        
        button.stat-btn:active { opacity: 0.7; transform: scale(0.98); }

        .btn-goal { background-color: var(--our-team-color); }
        .btn-missed { background-color: var(--blue); } 
        .btn-assist { background-color: var(--teal); }
        .btn-draw { background-color: var(--purple); }
        .btn-to-our { background-color: #ff6347; }
        .btn-to-opp { background-color: #cc3333; }
        .btn-save { background-color: var(--save-color); }
        
        /* Utility buttons slightly smaller font/padding */
        .btn-card { background-color: var(--card-color); color: #333 !important; padding: 8px; font-size: 12px; } 
        .btn-note { background-color: #8e8e93; padding: 8px; font-size: 12px; } 
        .btn-utility { padding: 8px; font-size: 12px; } 

        /* TRACKER CONTAINERS (UNCHANGED COMPACT) */
        #top-scorer-container {
            display: flex;
            justify-content: space-around;
            align-items: center;
            background-color: var(--card-bg);
            padding: 5px 10px; 
            border-radius: 8px;
            margin-top: 6px; 
            margin-bottom: 6px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
            text-align: center;
        }
        #card-tracker-container {
             display: flex;
             justify-content: space-around;
             align-items: center;
             background-color: var(--card-bg);
             padding: 5px 10px; 
             border-radius: 8px;
             margin-bottom: 6px; 
             box-shadow: 0 1px 2px rgba(0,0,0,0.1);
             text-align: center;
             border: 1px solid var(--card-color); 
             margin-top: 6px; 
        }
        .tracker-info { flex: 1; padding: 0 2px; }
        .tracker-label { font-size: 8px; color: #666; font-weight: bold; text-transform: uppercase; margin-bottom: 1px; }
        .tracker-details { font-size: 13px; font-weight: 900; }
        .tracker-details span { font-size: 10px; font-weight: normal; }
        .tracker-details.sub-label { font-size: 8px; color: #888; margin-top: 1px; }

        /* TIMER CONTAINER (UNCHANGED COMPACT) */
        #timer-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: var(--card-bg);
            padding: 5px 10px; 
            border-radius: 8px;
            margin-bottom: 6px; 
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
            margin-top: 0px; 
        }
        
        #timer-controls { display: flex; gap: 5px; align-items: center; }

        #game-timer { font-size: 22px; font-weight: 900; margin-right: 8px; color: var(--opponent-color); }
        .timer-running { color: var(--opponent-color); }
        .timer-paused { color: var(--blue); }
        .timer-expired { color: #000; }

        #timer-toggle-btn {
            background-color: var(--our-team-color);
            color: white; border: none; padding: 6px 12px; border-radius: 6px; font-size: 13px; font-weight: bold;
        }
        #timer-toggle-btn.pause { background-color: var(--orange); }

        #set-time-btn {
            background-color: var(--teal); color: white; border: none; padding: 5px 8px; border-radius: 6px; font-size: 11px; font-weight: bold;
        }
        
        /* --- BOTTOM WINDOW: HISTORY LIST (REDUCED) --- */
        #history-container {
            background-color: var(--card-bg);
            border-top: 1px solid #ccc;
            height: 20%; /* ADJUSTED: Smaller history panel (was 27%) */
            overflow-y: auto;
            flex-shrink: 0;
        }

        .history-item {
            padding: 8px 12px; 
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .history-info { font-weight: 500; font-size: 14px; }
        .history-player { color: #888; margin-left: 8px; font-size: 0.9em; }
        .history-time { font-size: 10px; color: #aaa; } 
        .delete-btn {
            background: none; border: none; color: var(--opponent-color); font-weight: bold; font-size: 14px;
            margin-left: 10px; cursor: pointer; padding: 5px;
        }

        /* MODAL STYLES (No Change) */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5);
            display: none; justify-content: center; align-items: flex-end;
            z-index: 100;
        }
        
        #team-modal-container, #to-modal-container {
            background: white; width: 100%; border-radius: 20px 20px 0 0;
            padding: 20px; box-shadow: 0 -5px 15px rgba(0,0,0,0.2);
            animation: slideUp 0.3s ease-out;
        }

        .team-choice-grid { display: flex; gap: 20px; margin: 20px 0; }
        .team-choice-btn {
            flex: 1; padding: 30px 10px; font-size: 18px; font-weight: bold; border-radius: 10px;
            border: none; color: white; cursor: pointer;
        }
        .team-our-btn { background-color: var(--our-team-color); }
        .team-opp-btn { background-color: var(--opponent-color); }
        .modal-title { text-align: center; font-size: 20px; font-weight: bold; margin-bottom: 10px; }

        #numpad-container {
            background: white; width: 100%; border-radius: 20px 20px 0 0;
            padding: 20px; box-shadow: 0 -5px 15px rgba(0,0,0,0.2);
            animation: slideUp 0.3s ease-out;
        }

        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

        #numpad-display {
            font-size: 40px; font-weight: bold; text-align: center; margin-bottom: 20px;
            height: 50px; border-bottom: 2px solid #eee;
        }

        #numpad-title { text-align: center; color: #888; font-weight: bold; margin-bottom: 10px; }

        .numpad-grid {
            display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px;
        }

        .num-btn {
            background: #e5e5ea; border: none; padding: 15px; font-size: 24px; border-radius: 10px;
        }
        
        .num-btn.ok { background-color: var(--our-team-color); color: white; }
        .num-btn.clear { background-color: var(--opponent-color); color: white; font-size: 18px; }
        .num-btn.unknown { background-color: #8e8e93; color: white; font-size: 24px; }
    </style>
</head>
<body>

    <div id="scoreboard">
        <div class="score-row">
            <div class="score-item">
                <span class="score-val">
                    <span class="team-our" id="score-our-goals">0</span>
                    <span class="score-sep">/</span>
                    <span class="team-opp" id="score-opp-goals">0</span>
                </span>
                <span class="score-label">Goals</span>
            </div>
            <div class="score-item">
                <span class="score-val">
                    <span class="team-our" id="score-our-draws">0</span>
                    <span class="score-sep">/</span>
                    <span class="team-opp" id="score-opp-draws">0</span>
                </span>
                <span class="score-label">Draws</span>
            </div>
            <div class="score-item">
                <span class="score-val">
                    <span class="team-our" id="score-our-to">0</span>
                    <span class="score-sep">/</span>
                    <span class="team-opp" id="score-opp-to">0</span>
                </span>
                <span class="score-label">TOs</span>
            </div>
        </div>
        
        <div class="score-row">
             <div class="score-item">
                <span class="score-val">
                    <span class="team-our" id="score-our-total-shots">0</span>
                    <span class="score-sep">/</span>
                    <span class="team-opp" id="score-opp-total-shots">0</span>
                </span>
                <span class="score-label">Tot. Shots</span>
            </div>
            <div class="score-item">
                <span class="score-val">
                    <span class="team-our" id="score-our-missed">0</span>
                    <span class="score-sep">/</span>
                    <span class="team-opp" id="score-opp-missed">0</span>
                </span>
                <span class="score-label">Missed</span>
            </div>
            <div class="score-item">
                <span class="score-val">
                    <span class="team-our" id="score-our-saves">0</span>
                    <span class="score-sep">/</span>
                    <span class="team-opp" id="score-opp-saves">0</span>
                </span>
                <span class="score-label">Saves</span>
            </div>
        </div>
    </div>

    <div id="main-content">
        <div class="grid">
            <button class="stat-btn btn-goal" onclick="handleStatClick('Goal')">Goal</button>
            <button class="stat-btn btn-missed" onclick="handleStatClick('Missed Shot')">Missed</button>
            <button class="stat-btn btn-assist" onclick="handleStatClick('Assist')">Assist</button>
            <button class="stat-btn btn-save" onclick="handleStatClick('Save')">Save</button>
            <button class="stat-btn btn-draw" onclick="handleStatClick('Draw')">Draw Ctrl</button>
            <button class="stat-btn btn-note" onclick="handleNoteClick()">Note</button>
        </div>
        
        <div class="grid">
            <button class="stat-btn btn-to-our" onclick="handleTOClick('Our')">Our TO</button>
            <button class="stat-btn btn-to-opp" onclick="handleTOClick('Opponent')">Opp TO</button>
        </div>

        <div class="grid-extended">
            <button class="stat-btn btn-card" onclick="handleStatClick('Yellow Card')">Y-Card</button>
            <button class="stat-btn btn-utility" style="background-color: var(--teal);" onclick="exportResults()">Export</button>
             <button class="stat-btn btn-utility" style="background-color: #555;" id="half-tracker-btn" onclick="switchHalf()">H1/H2</button>
        </div>
        
        <div id="timer-container">
            <div>
                <span class="score-label" style="display:block;">GAME CLOCK</span>
                <div id="game-timer" class="timer-paused">20:00</div>
            </div>
            <div id="timer-controls">
                <button id="timer-toggle-btn" onclick="toggleTimer()">START</button>
                <button id="set-time-btn" onclick="setTimerDuration()">Set Time</button>
            </div>
        </div>

        <div id="top-scorer-container">
            <div class="tracker-info">
                <div class="tracker-label">Our Top Scorer</div>
                <div class="tracker-details team-our" id="our-top-scorer">--</div>
            </div>
            <div style="width: 1px; background-color: #eee; height: 20px;"></div>
            <div class="tracker-info">
                <div class="tracker-label">Opp. Top Scorer</div>
                <div class="tracker-details team-opp" id="opp-top-scorer">--</div>
            </div>
        </div>


        <div id="card-tracker-container">
            <div class="tracker-info">
                <div class="tracker-label">Our Yellow Cards</div>
                <div class="tracker-details team-our" id="our-total-cards">0</div>
                <div class="tracker-details sub-label team-our" id="our-card-leader">--</div>
            </div>
            <div style="width: 1px; background-color: #eee; height: 20px;"></div>
            <div class="tracker-info">
                <div class="tracker-label">Opp. Yellow Cards</div>
                <div class="tracker-details team-opp" id="opp-total-cards">0</div>
                <div class="tracker-details sub-label team-opp" id="opp-card-leader">--</div>
            </div>
        </div>

        <p style="text-align:center; color:#999; font-size: 10px; margin-top:5px;">Stats saved automatically.</p>
    </div>

    <div id="history-container">
        </div>

    <div id="team-modal-overlay" class="modal-overlay">
        <div id="team-modal-container">
            <div id="team-modal-title" class="modal-title">Who got the stat?</div>
            <div class="team-choice-grid">
                <button class="team-choice-btn team-our-btn" onclick="selectTeam('Our')">Our Team</button>
                <button class="team-choice-btn team-opp-btn" onclick="selectTeam('Opponent')">Opponent</button>
            </div>
            <button onclick="closeModal('team')" style="width:100%; padding:10px; background:transparent; border:none; color:#007aff;">Cancel</button>
        </div>
    </div>
    
    <div id="to-modal-overlay" class="modal-overlay">
        <div id="to-modal-container">
            <div id="to-modal-title" class="modal-title">Turnover Classification</div>
            <p style="text-align: center; margin-bottom: 20px;">How did the possession change?</p>
            <div class="team-choice-grid">
                <button class="team-choice-btn team-our-btn" style="background-color: var(--teal);" onclick="classifyTurnover('Forced')">Forced</button>
                <button class="team-choice-btn team-opp-btn" style="background-color: var(--orange);" onclick="classifyTurnover('Unforced')">Unforced</button>
            </div>
            <button onclick="closeModal('to')" style="width:100%; padding:10px; background:transparent; border:none; color:#007aff;">Cancel</button>
        </div>
    </div>


    <div id="numpad-modal-overlay" class="modal-overlay">
        <div id="numpad-container">
            <div id="numpad-title">Enter Player #</div>
            <div id="numpad-display">_</div>
            <div class="numpad-grid">
                <button class="num-btn" onclick="numInput('1')">1</button>
                <button class="num-btn" onclick="numInput('2')">2</button>
                <button class="num-btn" onclick="numInput('3')">3</button>
                <button class="num-btn" onclick="numInput('4')">4</button>
                <button class="num-btn" onclick="numInput('5')">5</button>
                <button class="num-btn" onclick="numInput('6')">6</button>
                <button class="num-btn" onclick="numInput('7')">7</button>
                <button class="num-btn" onclick="numInput('8')">8</button>
                <button class="num-btn" onclick="numInput('9')">9</button>
                <button class="num-btn unknown" onclick="numInput('?')">?</button> 
                <button class="num-btn" onclick="numInput('0')">0</button>
                <button class="num-btn ok" onclick="submitNum()">OK</button>
            </div>
            <button onclick="closeModal('numpad')" style="width:100%; margin-top:10px; padding:10px; background:transparent; border:none; color:#007aff;">Cancel</button>
        </div>
    </div>

    <script>
        // --- APP STATE (UNMODIFIED) ---
        let events = [];
        let pendingStat = { type: null, team: null, requiresNumber: false };
        let currentNumber = "";
        let currentHalf = 1; 
        
        // Timer State
        let currentDurationMinutes = 20; 
        let timerInterval = null;
        let timeLeftSeconds = currentDurationMinutes * 60; 
        let currentRunStartTime = 0; 

        const STATS_REQUIRING_NUM = ['Goal', 'Missed Shot', 'Assist', 'Yellow Card', 'Save'];
        
        const GAME_SUMMARY_STAT_TYPES = [
            'Goal', 'Save', 'Missed Shot', 'Assist', 'Draw', 'TO Unforced', 'TO Forced', 'Ground Ball', 'Yellow Card'
        ];
        
        const ALL_TEAMS = ['Our', 'Opponent'];

        // --- INITIALIZATION (UNMODIFIED) ---
        window.onload = function() {
            const savedData = localStorage.getItem('laxEvents');
            if(savedData) events = JSON.parse(savedData);
            
            const savedHalf = localStorage.getItem('currentHalf');
            if(savedHalf) currentHalf = parseInt(savedHalf);
            
            const savedDuration = localStorage.getItem('timerDurationMinutes');
            if (savedDuration) currentDurationMinutes = parseInt(savedDuration);
            
            const savedTimeLeft = localStorage.getItem('timeLeftSeconds');
            timeLeftSeconds = (savedTimeLeft !== null) ? parseInt(savedTimeLeft) : currentDurationMinutes * 60;
            
            const timerIsRunning = localStorage.getItem('timerIsRunning') === 'true';
            
            if (timerIsRunning) {
                const lastSaveTime = parseInt(localStorage.getItem('lastSaveTime'));
                const timePassedSinceSave = Math.floor((Date.now() - lastSaveTime) / 1000);
                timeLeftSeconds = Math.max(0, timeLeftSeconds - timePassedSinceSave);
                localStorage.setItem('timeLeftSeconds', timeLeftSeconds);
                
                if (timeLeftSeconds > 0) {
                    toggleTimer(true); 
                } else {
                    localStorage.setItem('timerIsRunning', 'false');
                }
            }
            
            document.getElementById('game-timer').innerText = formatTime(timeLeftSeconds);
            updateUI();
            updateTimerToggleBtn(timerIsRunning && timeLeftSeconds > 0);
            updateHalfButton();
        };

        function updateHalfButton() {
            const halfButton = document.getElementById('half-tracker-btn');
            if (currentHalf === 1) {
                halfButton.innerText = `H1 / H2`;
                halfButton.style.backgroundColor = 'var(--purple)';
            } else if (currentHalf === 2) {
                halfButton.innerText = "H2 / END";
                halfButton.style.backgroundColor = 'var(--opponent-color)';
            } else {
                halfButton.innerText = "NEW GAME";
                halfButton.style.backgroundColor = 'var(--blue)';
            }
        }

        // --- TIMER FUNCTIONS (UNMODIFIED) ---
        function formatTime(totalSeconds) {
            if (totalSeconds < 0) totalSeconds = 0;
            const minutes = Math.floor(totalSeconds / 60);
            const seconds = totalSeconds % 60;
            return `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }
        
        function updateTimerToggleBtn(isRunning) {
            const btn = document.getElementById('timer-toggle-btn');
            if (isRunning) {
                btn.innerText = 'PAUSE';
                btn.classList.add('pause');
            } else {
                btn.innerText = 'START';
                btn.classList.remove('pause');
            }
        }
        
        function toggleTimer(forceResume = false) {
            if (timeLeftSeconds <= 0) {
                alert("Game Clock has expired and cannot be resumed.");
                return;
            }
            
            if (timerInterval && !forceResume) {
                // PAUSE
                clearInterval(timerInterval);
                timerInterval = null;
                localStorage.setItem('timerIsRunning', 'false');
                localStorage.setItem('timeLeftSeconds', timeLeftSeconds); 
                localStorage.removeItem('lastSaveTime');

                document.getElementById('game-timer').innerText = formatTime(timeLeftSeconds);
                document.getElementById('game-timer').classList.remove('timer-running');
                document.getElementById('game-timer').classList.add('timer-paused');
                updateTimerToggleBtn(false);
            } else {
                // START
                if (timerInterval) clearInterval(timerInterval); 
                currentRunStartTime = Date.now();
                const startingTimeLeft = timeLeftSeconds; 
                
                localStorage.setItem('timerIsRunning', 'true');
                localStorage.setItem('lastSaveTime', Date.now());

                document.getElementById('game-timer').classList.add('timer-running');
                document.getElementById('game-timer').classList.remove('timer-paused');
                updateTimerToggleBtn(true);
                
                timerInterval = setInterval(() => {
                    const elapsedSeconds = Math.floor((Date.now() - currentRunStartTime) / 1000);
                    const newTimeLeft = Math.max(0, startingTimeLeft - elapsedSeconds);
                    
                    document.getElementById('game-timer').innerText = formatTime(newTimeLeft);
                    
                    if (newTimeLeft !== timeLeftSeconds) {
                        timeLeftSeconds = newTimeLeft;
                        localStorage.setItem('timeLeftSeconds', timeLeftSeconds);
                        localStorage.setItem('lastSaveTime', Date.now()); 
                    }
                    
                    if (newTimeLeft <= 0) {
                        clearInterval(timerInterval);
                        timerInterval = null;
                        timeLeftSeconds = 0;
                        localStorage.setItem('timeLeftSeconds', 0);
                        localStorage.setItem('timerIsRunning', 'false');
                        document.getElementById('game-timer').classList.remove('timer-running');
                        document.getElementById('game-timer').classList.add('timer-expired');
                        updateTimerToggleBtn(false);
                        alert("Game Clock has expired!");
                    }
                }, 100);
            }
        }

        function resetTimer() {
            clearInterval(timerInterval);
            timerInterval = null;
            localStorage.setItem('timerIsRunning', 'false');
            localStorage.removeItem('lastSaveTime');
            timeLeftSeconds = currentDurationMinutes * 60;
            localStorage.setItem('timeLeftSeconds', timeLeftSeconds);
            
            document.getElementById('game-timer').innerText = formatTime(timeLeftSeconds);
            document.getElementById('game-timer').classList.remove('timer-running');
            document.getElementById('game-timer').classList.remove('timer-expired');
            document.getElementById('game-timer').classList.add('timer-paused');
            updateTimerToggleBtn(false);
        }
        
        function setTimerDuration() {
            if (timerInterval) toggleTimer(); 
            const newDuration = prompt(`Enter new half duration in minutes (Current: ${currentDurationMinutes} min):`);
            if (newDuration === null) return; 
            const minutes = parseInt(newDuration.trim());
            if (isNaN(minutes) || minutes <= 0 || minutes > 99) {
                alert("Please enter a valid number (1-99).");
                return;
            }
            currentDurationMinutes = minutes;
            localStorage.setItem('timerDurationMinutes', currentDurationMinutes);
            resetTimer();
        }

        // --- CORE LOGIC (UNMODIFIED) ---
        function switchHalf() {
            if (timerInterval) toggleTimer(); 
            
            if (currentHalf === 1) {
                if (confirm(`End Half 1? Timer resets to ${currentDurationMinutes}:00.`)) {
                    currentHalf = 2;
                    resetTimer();
                } else return;
            } else if (currentHalf === 2) {
                if (confirm("End Half 2 and finalize game?")) {
                    currentHalf = 3; 
                    clearInterval(timerInterval);
                    timerInterval = null;
                    localStorage.setItem('timerIsRunning', 'false');
                    document.getElementById('game-timer').classList.remove('timer-running');
                    document.getElementById('game-timer').classList.add('timer-paused');
                    updateTimerToggleBtn(false);
                } else return;
            } else {
                if (confirm("Start NEW GAME? This clears ALL stats.")) {
                    currentHalf = 1;
                    events = [];
                    localStorage.removeItem('laxEvents');
                    resetTimer();
                } else return;
            }
            localStorage.setItem('currentHalf', currentHalf); 
            updateUI();
            updateHalfButton();
        }

        function handleStatClick(type) {
            if (currentHalf === 3) {
                alert("Game ended. Press 'NEW GAME'.");
                return;
            }
            pendingStat.type = type;
            pendingStat.requiresNumber = STATS_REQUIRING_NUM.includes(type);

            let title = (pendingStat.type === 'Save') 
                ? `Shot taken by? (Our Save = Opp Shot)` 
                : `Who earned the ${type}?`;
            
            document.getElementById('team-modal-title').innerText = title;
            document.getElementById('team-modal-overlay').style.display = "flex";
        }
        
        function handleTOClick(team) {
            if (currentHalf === 3) { alert("Game ended."); return; }
            pendingStat.team = team;
            document.getElementById('to-modal-title').innerText = `${team} Turnover Type`;
            document.getElementById('to-modal-overlay').style.display = "flex";
        }

        function handleNoteClick() {
            if (currentHalf === 3) { alert("Game ended."); return; }
            const note = prompt("Enter note:");
            if (note && note.trim() !== "") addEvent('Note', 'Game', note); 
        }
        
        function classifyTurnover(classification) {
            let type = (classification === 'Forced') ? 'TO Forced' : 'TO Unforced';
            addEvent(type, pendingStat.team, null);
            closeModal('to');
            pendingStat = { type: null, team: null, requiresNumber: false };
        }

        function selectTeam(team) {
            pendingStat.team = team;
            closeModal('team');

            const isOurShooterOppSave = (team === 'Our' && pendingStat.type === 'Save'); 
            const needsNumpad = 
                (team === 'Our' && pendingStat.requiresNumber) || 
                (team === 'Opponent' && (pendingStat.type === 'Goal' || pendingStat.type === 'Yellow Card' || pendingStat.type === 'Save')) || 
                isOurShooterOppSave;

            if (needsNumpad) {
                currentNumber = "";
                document.getElementById('numpad-display').innerText = "_";
                let title;
                if (pendingStat.type === 'Save') {
                    title = (team === 'Opponent') ? `OUR Goalie # (Opp Shot)` : `OUR Shooter # (Opp Save)`;
                } else if (team === 'Our') {
                    title = `Our Player # for ${pendingStat.type}`;
                } else {
                    title = `Opp Player # for ${pendingStat.type}`;
                }
                document.getElementById('numpad-title').innerText = title;
                document.getElementById('numpad-modal-overlay').style.display = "flex";
            } else {
                addEvent(pendingStat.type, pendingStat.team, null);
            }
        }

        function addEvent(type, team, playerNum) {
            let finalPlayerNum = playerNum;
            if (playerNum === '?') {
                if (type === 'Save') finalPlayerNum = team === 'Opponent' ? 'GOALIE' : '??'; 
                else finalPlayerNum = team === 'Opponent' ? 'OPP??' : '??';
            } else if (!playerNum) {
                 finalPlayerNum = null;
            }

            const newEvent = {
                id: Date.now(),
                type: type,
                team: team, 
                player: finalPlayerNum,
                time: formatTime(timeLeftSeconds), 
                half: currentHalf
            };
            events.unshift(newEvent);
            saveAndRender();
            
            if (!timerInterval && timeLeftSeconds === currentDurationMinutes * 60) toggleTimer(true);
        }

        function deleteEvent(id) {
            if(confirm("Delete this event?")) {
                events = events.filter(e => e.id !== id);
                saveAndRender();
            }
        }

        function saveAndRender() {
            localStorage.setItem('laxEvents', JSON.stringify(events));
            localStorage.setItem('currentHalf', currentHalf); 
            localStorage.setItem('timerDurationMinutes', currentDurationMinutes); 
            localStorage.setItem('timeLeftSeconds', timeLeftSeconds); 
            if (localStorage.getItem('timerIsRunning') === 'true') {
                 localStorage.setItem('lastSaveTime', Date.now());
            }
            updateUI();
        }

        function calculateTopScorers() {
            const ourScorers = {};
            const oppScorers = {};
            const goalEvents = events.filter(e => e.type === 'Goal' && e.player && !['?', '??', 'OPP??', 'GOALIE'].includes(e.player));

            goalEvents.forEach(e => {
                if (e.team === 'Our') ourScorers[e.player] = (ourScorers[e.player] || 0) + 1;
                else if (e.team === 'Opponent') oppScorers[e.player] = (oppScorers[e.player] || 0) + 1;
            });

            const findTopPlayer = (scorerMap) => {
                let topPlayer = { player: '--', count: 0 };
                for (const player in scorerMap) {
                    if (scorerMap[player] > topPlayer.count) {
                        topPlayer.player = player;
                        topPlayer.count = scorerMap[player];
                    }
                }
                return topPlayer;
            };

            const ourTop = findTopPlayer(ourScorers);
            const oppTop = findTopPlayer(oppScorers);
            
            const ourDisplay = document.getElementById('our-top-scorer');
            const oppDisplay = document.getElementById('opp-top-scorer');

            ourDisplay.innerHTML = (ourTop.count > 0) ? `#${ourTop.player} <span>(${ourTop.count})</span>` : '--';
            oppDisplay.innerHTML = (oppTop.count > 0) ? `#${oppTop.player} <span>(${oppTop.count})</span>` : '--';
        }
        
        function calculateCardTracker() {
            const ourCards = events.filter(e => e.type === 'Yellow Card' && e.team === 'Our');
            const oppCards = events.filter(e => e.type === 'Yellow Card' && e.team === 'Opponent');

            document.getElementById('our-total-cards').innerText = ourCards.length;
            document.getElementById('opp-total-cards').innerText = oppCards.length;
            
            const ourCardLeaders = {};
            const oppCardLeaders = {};
            const validCards = events.filter(e => e.type === 'Yellow Card' && e.player && !['?', '??', 'OPP??', 'GOALIE'].includes(e.player));

            validCards.forEach(e => {
                if (e.team === 'Our') ourCardLeaders[e.player] = (ourCardLeaders[e.player] || 0) + 1;
                else if (e.team === 'Opponent') oppCardLeaders[e.player] = (oppCardLeaders[e.player] || 0) + 1;
            });

            const findTopPlayer = (cardMap) => {
                let topPlayer = { player: '--', count: 0 };
                for (const player in cardMap) {
                    if (cardMap[player] > topPlayer.count) {
                        topPlayer.player = player;
                        topPlayer.count = cardMap[player];
                    }
                }
                return topPlayer;
            };

            const ourTopCarder = findTopPlayer(ourCardLeaders);
            const oppTopCarder = findTopPlayer(oppCardLeaders);

            const ourLeaderDisplay = document.getElementById('our-card-leader');
            const oppLeaderDisplay = document.getElementById('opp-card-leader');

            ourLeaderDisplay.innerHTML = (ourTopCarder.count > 0) ? `Most: #${ourTopCarder.player} (${ourTopCarder.count})` : 'No tracked leaders';
            oppLeaderDisplay.innerHTML = (oppTopCarder.count > 0) ? `Most: #${oppTopCarder.player} (${oppTopCarder.count})` : 'No tracked leaders';
        }

        function updateUI() {
            // Tally Stats
            const countStats = (type, team) => events.filter(e => e.type === type && e.team === team).length;
            const countTOs = (team) => events.filter(e => (e.type === 'TO Forced' || e.type === 'TO Unforced') && e.team === team).length;
            
            const ourGoals = countStats('Goal', 'Our');
            const oppGoals = countStats('Goal', 'Opponent');
            const ourDraws = countStats('Draw', 'Our');
            const oppDraws = countStats('Draw', 'Opponent');
            const ourTOs = countTOs('Our');
            const oppTOs = countTOs('Opponent');
            const ourSaves = countStats('Save', 'Opponent'); 
            const oppSaves = countStats('Save', 'Our'); 
            const ourMissed = countStats('Missed Shot', 'Our');
            const oppMissed = countStats('Missed Shot', 'Opponent');
            const ourTotalShots = ourGoals + oppSaves + ourMissed;
            const oppTotalShots = oppGoals + ourSaves + oppMissed;

            // Update Scoreboard
            document.getElementById('score-our-goals').innerText = ourGoals;
            document.getElementById('score-opp-goals').innerText = oppGoals;
            document.getElementById('score-our-draws').innerText = ourDraws;
            document.getElementById('score-opp-draws').innerText = oppDraws;
            document.getElementById('score-our-to').innerText = ourTOs;
            document.getElementById('score-opp-to').innerText = oppTOs;
            // Swapped order in HTML, but logic remains the same
            document.getElementById('score-our-total-shots').innerText = ourTotalShots;
            document.getElementById('score-opp-total-shots').innerText = oppTotalShots;
            document.getElementById('score-our-missed').innerText = ourMissed;
            document.getElementById('score-opp-missed').innerText = oppMissed;
            document.getElementById('score-our-saves').innerText = ourSaves;
            document.getElementById('score-opp-saves').innerText = oppSaves;
            
            calculateTopScorers();
            calculateCardTracker();

            // Update History List
            const listContainer = document.getElementById('history-container');
            listContainer.innerHTML = '';
            
            events.forEach(e => {
                const teamClass = e.team === 'Our' ? 'team-our' : (e.team === 'Opponent' ? 'team-opp' : 'team-note');
                const teamTag = e.team === 'Our' ? 'OUR' : (e.team === 'Opponent' ? 'OPP' : 'NOTE');
                const halfTag = e.half < 3 ? `H${e.half}` : 'F'; 

                const div = document.createElement('div');
                div.className = 'history-item';
                
                let infoContent;
                if (e.type === 'Note') {
                    infoContent = `<span class="history-info" style="color:#8e8e93; font-style: italic;">NOTE: ${e.player}</span>`;
                } else if (e.type === 'Save') {
                    const saveByTeam = e.team === 'Opponent' ? 'OUR' : 'OPP';
                    let playerDisplay = '';
                    if (e.player && e.player !== '??' && e.player !== 'GOALIE') {
                         const role = e.team === 'Opponent' ? 'G' : 'S'; 
                         playerDisplay = `#${e.player} (${role})`;
                    } else if (e.player) {
                        playerDisplay = e.player; 
                    }
                    infoContent = `<span class="history-info ${saveByTeam === 'OUR' ? 'team-our' : 'team-opp'}">${saveByTeam} Save</span>${playerDisplay ? `<span class="history-player">${playerDisplay}</span>` : ''}`;
                } else {
                    let playerDisplay = '';
                    if (e.player && e.player !== '??' && e.player !== 'OPP??') playerDisplay = `#${e.player}`;
                    else if (e.player) playerDisplay = e.player; 
                    
                    infoContent = `<span class="history-info ${teamClass}">${teamTag} ${e.type}</span>${playerDisplay ? `<span class="history-player">${playerDisplay}</span>` : ''}`;
                }

                div.innerHTML = `<div>${infoContent}</div><div><span style="font-size:12px; margin-right: 5px;">${halfTag} @ ${e.time}</span><button class="delete-btn" onclick="deleteEvent(${e.id})">âœ•</button></div>`;
                listContainer.appendChild(div);
            });
        }
        
        // --- CSV/TSV EXPORT FUNCTION (UNMODIFIED) ---
        function exportResults() {
            const DELIMITER = "\t"; 
            let tsvContent = "data:text/tab-separated-values;charset=utf-8,";
            let rows = [];

            rows.push(["Period", "Our_Player_Numbers", "Ours", "Stat", "Theirs", "Their_Player_Numbers"].join(DELIMITER));

            const periods = [1, 2, 'Total'];
            periods.forEach(period => {
                const isTotal = (period === 'Total');
                GAME_SUMMARY_STAT_TYPES.forEach(statType => {
                    let oursCount = 0, theirsCount = 0;
                    let ourPlayerNumbers = "", theirPlayerNumbers = "";
                    const periodEvents = isTotal ? events : events.filter(e => e.half === period);

                    const formatPlayerNumbers = (eventList) => {
                        return eventList.filter(e => e.player).map(e => {
                            if (e.player === '??') return '??';
                            if (e.player === 'OPP??') return 'OPP??';
                            if (e.player === 'GOALIE') return 'GOALIE';
                            return `#${e.player}`;
                        }).join(' ');
                    };

                    if (statType === 'Save') {
                        const ourSaveEvents = periodEvents.filter(e => e.type === 'Save' && e.team === 'Opponent');
                        oursCount = ourSaveEvents.length;
                        const oppSaveEvents = periodEvents.filter(e => e.type === 'Save' && e.team === 'Our');
                        theirsCount = oppSaveEvents.length;
                        ourPlayerNumbers = formatPlayerNumbers(ourSaveEvents);
                    } else {
                        const ourEventsForStat = periodEvents.filter(e => e.type === statType && e.team === 'Our');
                        const theirEventsForStat = periodEvents.filter(e => e.type === statType && e.team === 'Opponent');

                        oursCount = ourEventsForStat.length;
                        theirsCount = theirEventsForStat.length;
                        if (['Goal', 'Assist', 'Missed Shot', 'Yellow Card', 'Ground Ball'].includes(statType)) {
                            ourPlayerNumbers = formatPlayerNumbers(ourEventsForStat);
                        }
                        if (['Goal', 'Yellow Card'].includes(statType)) {
                            theirPlayerNumbers = formatPlayerNumbers(theirEventsForStat);
                        }
                    }
                    
                    rows.push([isTotal ? 'Total' : period, ourPlayerNumbers, oursCount, statType, theirsCount, theirPlayerNumbers].map(value => {
                        if (typeof value === 'string') return `"${value.replace(/"/g, "'").replace(/\t/g, ' ')}"`;
                        return value;
                    }).join(DELIMITER));
                });
            });

            const totalOurGoals = events.filter(e => e.type === 'Goal' && e.team === 'Our').length;
            const totalOppGoals = events.filter(e => e.type === 'Goal' && e.team === 'Opponent').length;
            rows.push('\n\n'); 
            rows.push([`Total Goal Differential (+/-)`, '', (totalOurGoals - totalOppGoals), '', '', ''].join(DELIMITER)); 

            const ourTotalShots = totalOurGoals + events.filter(e => e.type === 'Save' && e.team === 'Our').length + events.filter(e => e.type === 'Missed Shot' && e.team === 'Our').length;
            const oppTotalShots = totalOppGoals + events.filter(e => e.type === 'Save' && e.team === 'Opponent').length + events.filter(e => e.type === 'Missed Shot' && e.team === 'Opponent').length;
            rows.push([`Total Shots (Goal + Save + Missed)`, '', ourTotalShots, '', oppTotalShots, ''].join(DELIMITER));
            
            rows.push('\n\n--- Game Notes ---\n');
            const notes = events.filter(e => e.type === 'Note');
            if (notes.length > 0) {
                rows.push(["Half", "Time", "Note Content"].join(DELIMITER));
                notes.forEach(note => {
                    const noteContent = note.player.replace(/"/g, "'").replace(/[\t,]/g, ';'); 
                    rows.push([note.half, note.time, noteContent].join(DELIMITER));
                });
            } else rows.push('No notes recorded.');

            const encodedUri = encodeURI(tsvContent + rows.join('\n'));
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            const date = new Date().toLocaleDateString('en-US', {month: '2-digit', day: '2-digit'}).replace(/\//g, '-');
            link.setAttribute("download", `LaxStats_Summary_Report_${date}.tsv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        // --- NUMPAD LOGIC and MODAL CONTROLS (UNMODIFIED) ---
        function numInput(val) {
            const display = document.getElementById('numpad-display');
            if (val === 'CL') { currentNumber = ""; display.innerText = "_"; return; }
            if (val === '?') { addEvent(pendingStat.type, pendingStat.team, val); closeModal('numpad'); return; }
            if (currentNumber.length < 2) { currentNumber += val; display.innerText = currentNumber; }
        }
        function submitNum() { if (currentNumber !== "") { addEvent(pendingStat.type, pendingStat.team, currentNumber); closeModal('numpad'); } }
        function closeModal(modalType) {
            if (modalType === 'team') document.getElementById('team-modal-overlay').style.display = "none";
            else if (modalType === 'numpad') document.getElementById('numpad-modal-overlay').style.display = "none";
            else if (modalType === 'to') document.getElementById('to-modal-overlay').style.display = "none";
            
            if (modalType === 'numpad' || modalType === 'to') pendingStat = { type: null, team: null, requiresNumber: false };
        }
    </script>
</body>
</html>
